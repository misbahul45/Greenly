version: "3.9"

networks:
  greenly_network:
    name: greenly_network

volumes:
  mysql_data:
  mongo_data:
  redis_data:

services:
  # ==============================
  # Traefik Reverse Proxy
  # ==============================
  traefik:
    image: traefik:v2.11
    container_name: traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=greenly_network"
      - "--providers.file.filename=/etc/traefik/dynamic.yml"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml
    networks:
      - greenly_network

  # ==============================
  # Databases
  # ==============================
  mysql:
    image: mysql:8.0
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: greenly_core
      MYSQL_USER: greenly
      MYSQL_PASSWORD: greenly
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - greenly_network

  mongodb:
    image: mongo:7
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: root
    volumes:
      - mongo_data:/data/db
    networks:
      - greenly_network

  redis:
    image: redis:7
    container_name: redis
    restart: always
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    networks:
      - greenly_network

  # ==============================
  # Services
  # ==============================
  core-service:
    build:
      context: ../services/core-service
      dockerfile: Dockerfile.dev
    volumes:
      - ../services/core-service:/app
      - /app/node_modules
    depends_on:
      - mysql
      - redis
    environment:
      DATABASE_HOST: mysql
      DATABASE_PORT: 3306
      DATABASE_USER: greenly
      DATABASE_PASSWORD: greenly
      DATABASE_NAME: greenly_core
      REDIS_HOST: redis
      REDIS_PORT: 6379
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.core.rule=Host(`core.localhost`)"
      - "traefik.http.routers.core.entrypoints=web"
      - "traefik.http.services.core.loadbalancer.server.port=3000"
      - "traefik.http.routers.core.middlewares=security-headers@file,rate-limit@file"
    networks:
      - greenly_network

  catalog-service:
    build:
      context: ../services/catalog-service
      dockerfile: Dockerfile.dev
    volumes:
      - ../services/catalog-service:/app
    depends_on:
      - mongodb
      - redis
    environment:
      MONGO_URI: mongodb://root:root@mongodb:27017/?authSource=admin
      REDIS_HOST: redis
      REDIS_PORT: 6379
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.catalog.rule=Host(`catalog.localhost`)"
      - "traefik.http.routers.catalog.entrypoints=web"
      - "traefik.http.services.catalog.loadbalancer.server.port=8080"
      - "traefik.http.routers.catalog.middlewares=security-headers@file,rate-limit@file"
    networks:
      - greenly_network

  ml-engine:
    build:
      context: ../services/ml-engine
      dockerfile: Dockerfile.dev
    volumes:
      - ../services/ml-engine:/app
    depends_on:
      - redis
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ml.rule=Host(`ml.localhost`)"
      - "traefik.http.routers.ml.entrypoints=web"
      - "traefik.http.services.ml.loadbalancer.server.port=8000"
      - "traefik.http.routers.ml.middlewares=security-headers@file,rate-limit@file"
    networks:
      - greenly_network
